dist: xenial
language: csharp
mono: none
sudo: required

git:
    depth: 3
    quiet: true

addons:
    snaps:
      - name: dotnet-sdk
        confinement: classic
        channel: 3.1/stable

install:
    - export PATH="$PATH:/home/travis/.dotnet/tools"
    - export PATH="$PATH:$HOME/.local/bin"
    - sudo snap alias dotnet-sdk.dotnet dotnet

global:
    - DOTNET_SKIP_FIRST_TIME_EXPERIENCE=true
    - DOTNET_CLI_TELEMETRY_OPTOUT=1

solution: FreeserfNet.sln
script:
  - dotnet --version
  - dotnet restore FreeserfNet.sln --verbosity normal
  - dotnet msbuild -p:Configuration=LinuxRelease -p:DefineConstants=LINUX FreeserfNet.sln
  - dotnet test FreeserfNet.sln -c LinuxRelease --no-build --verbosity normal
  - dotnet publish -c LinuxRelease FreeserfNet/FreeserfNet.csproj -p:DefineConstants=LINUX -p:PublishSingleFile=true -r ubuntu-x64

stages:
  - name: deploy
    if: branch = master AND type = push AND os = linux

before_deploy:
  - mkdir deploy
  - cd deploy
  - mkdir FreeserfNet
  - cd ..
  - cp -r FreeserfNet/bin/LinuxRelease/ubuntu-x64/publish/. deploy/FreeserfNet/
  - cp changelog.txt deploy/FreeserfNet/changelog
  - cp FreeserfNet/bass/linux-x64/*.so deploy/FreeserfNet/
  - cd deploy
  - cd FreeserfNet
  - chmod +x FreeserfNet
  - cd ..
  - tar -czf ../Freeserf.net-Linux.tar.gz FreeserfNet
  - cd ..

deploy:
    provider: releases
    api_key:
      secure: ku89dMTVkz+PE5bvxWQCLG9PbNTa9tQUsidZ/7726rLEZjIAvDcxEC668Ix9zYmw
    file: Freeserf.net-Linux.tar.gz
    skip_cleanup: true
    draft: true
    overwrite: true
    prerelease: false
    name: $TRAVIS_TAG
    body: 'Release $TRAVIS_TAG'
    on:
        tags: true
